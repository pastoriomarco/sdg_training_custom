# TAO RT-DETR training spec for datasets generated by:
# src/sdg_training_custom/custom_sdg/custom_datagen_convert_yolov8.sh
#
# This spec assumes these Docker mounts:
#   -v /home/tndlux/workspaces/sdg:/workspace
#   -v /home/tndlux/synthetic_out:/data/synthetic_out
#
# Update dataset.num_classes to match your class count.

results_dir: /workspace/src/sdg_training_custom/rt-detr/results

dataset:
  train_data_sources:
    - image_dir: /data/synthetic_out/train
      json_file: /data/synthetic_out/train/coco_annotations.json
  val_data_sources:
    image_dir: /data/synthetic_out/val
    json_file: /data/synthetic_out/val/coco_annotations.json
  test_data_sources:
    image_dir: /data/synthetic_out/test
    json_file: /data/synthetic_out/test/coco_annotations.json
  infer_data_sources:
    image_dir:
      - /data/synthetic_out/val/Replicator
    classmap: /data/synthetic_out/classmap.txt
  batch_size: 6
  workers: 8
  remap_mscoco_category: false
  pin_memory: true
  dataset_type: serialized
  num_classes: 1
  eval_class_ids: null
  augmentation:
    multi_scales:
      - 640
    train_spatial_size:
      - 640
      - 640
    eval_spatial_size:
      - 640
      - 640
    distortion_prob: 0.8
    iou_crop_prob: 0.8
    preserve_aspect_ratio: false

model:
  backbone: resnet_50
  train_backbone: true
  return_interm_indices: [1, 2, 3]
  dec_layers: 6
  enc_layers: 1
  num_queries: 300

train:
  optim:
    lr: 0.0002
    lr_backbone: 0.00002
    momentum: 0.9
    weight_decay: 0.0001
    lr_scheduler: MultiStep
    lr_decay: 0.1
    lr_steps: [60]
    optimizer: AdamW
  num_epochs: 80
  checkpoint_interval: 5
  validation_interval: 5
  clip_grad_norm: 0.1
  precision: fp16
  distributed_strategy: ddp
  activation_checkpoint: true
  num_gpus: 1
  gpu_ids: [0]
  num_nodes: 1
  seed: 1234
  # Optional fine-tune from an RT-DETR checkpoint:
  # pretrained_model_path: /workspace/path/to/pretrained_model.pth

evaluate:
  conf_threshold: 0.0

inference:
  conf_threshold: 0.5
  color_map:
    custom: green

export:
  input_channel: 3
  input_width: 640
  input_height: 640
  on_cpu: false
  opset_version: 17
  batch_size: -1

gen_trt_engine:
  tensorrt:
    data_type: FP16
    workspace_size: 2048
    min_batch_size: 1
    opt_batch_size: 1
    max_batch_size: 1
